<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Canon ë ˆì‹œí”¼ & LUT ì œë„¤ë ˆì´í„° (v8.2 Quick/Pro)</title>

  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.21.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface@0.0.7/dist/blazeface.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.0/dist/mobilenet.min.js"></script>

  <style>
    :root{
      --bg:#0f172a; --card:#1e293b; --muted:#94a3b8; --text:#f8fafc;
      --line:#334155; --brand:#ff3f34; --ok:#10b981; --warn:#f59e0b;
      --cyan:#06b6d4; --black:#020617; --radius: 16px;
    }
    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    body{
      margin:0; font-family: -apple-system, BlinkMacSystemFont, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
      background: var(--bg); color:var(--text); padding: 16px; line-height: 1.5;
    }
    .app{ max-width: 1000px; margin: 0 auto; padding-bottom: 40px; }

    .header{ display:flex; flex-direction:column; gap:12px; margin-bottom:20px; }
    .title h1{ margin:0; font-size:20px; letter-spacing:-0.5px; }
    .title p{ margin:4px 0 0; color:var(--muted); font-size:13px; word-break: keep-all; }

    .badges{ display:flex; gap:8px; flex-wrap:wrap; }
    .badge{
      border:1px solid var(--line); background:rgba(30,41,59,0.7);
      padding:6px 12px; border-radius:999px; font-size:11px; font-weight:700;
      display:flex; gap:6px; align-items:center;
    }
    .dot{ width:8px; height:8px; border-radius:50%; background:var(--muted); }
    .dot.ok{ background:var(--ok); } .dot.warn{ background:var(--warn); }

    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
    @media (max-width: 800px){ .grid{ grid-template-columns:1fr; } }

    .card{
      background: var(--card); border:1px solid var(--line); border-radius:var(--radius);
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.2); overflow:hidden;
    }
    .card-h{
      padding:16px; display:flex; align-items:center; justify-content:space-between;
      border-bottom:1px solid var(--line); background: rgba(15,23,42,0.4);
      gap:10px; flex-wrap:wrap;
    }
    .card-h strong{ font-size:15px; }
    .step{
      font-size:12px; color:var(--muted); padding:4px 10px; border:1px solid var(--line);
      border-radius:999px; background:var(--bg); font-weight:700;
    }
    .card-b{ padding:16px; }

    .uploader{ display:flex; flex-direction:column; gap:12px; }

    .drop{
      border:2px dashed var(--line); background: rgba(15,23,42,0.5); border-radius:12px;
      padding:18px; transition: 0.2s; cursor:pointer; min-height: 150px;
      display:flex; flex-direction:column; gap:8px; justify-content:center; align-items:center; text-align:center;
      position:relative;
    }
    .drop:active{ background:rgba(255,63,52,0.1); border-color:var(--brand); }
    .drop.dragover{ border-color: var(--ok); background: rgba(16,185,129,0.1); }
    .drop .label{ font-weight:900; font-size:14px; }
    .drop .hint{
      color:var(--muted); font-size:12px; line-height:1.45; max-width: 360px;
    }
    .drop input{ display:none; }
    .thumb{
      width:100%; display:none; border-radius:8px; max-height:140px; object-fit:cover;
      border:1px solid var(--line);
    }
    .filename{
      font-size:12px; color: var(--cyan); font-weight:900; display:none; word-break:break-all;
    }

    .btn{
      border:0; border-radius:12px; padding:16px; font-weight:900; cursor:pointer;
      transition:0.2s; font-size:14px; width: 100%;
      display: flex; justify-content: center; align-items: center; gap:8px;
    }
    .btn.primary{ background: var(--brand); color:white; }
    .btn.primary:active{ filter: brightness(0.9); transform: scale(0.98); }
    .btn.ghost{ background: rgba(30,41,59,0.8); border:1px solid var(--line); color: var(--text); }
    .btn.lut{ background: var(--cyan); color: #000; }
    .btn:disabled{ opacity:0.4; cursor:not-allowed; transform:none !important; }

    .mini{
      color:var(--muted); font-size:12px; border:1px solid var(--line);
      background: var(--bg); padding:12px; border-radius:10px;
      word-break: keep-all; line-height: 1.55;
    }

    .seg{
      display:flex; flex-direction:column; gap:8px;
      border:1px solid var(--line); background: var(--bg); padding:12px;
      border-radius:12px; margin-bottom: 12px;
    }
    .seg .label{ color:var(--muted); font-size:12px; font-weight:900; }

    .chips{ display:flex; flex-wrap:wrap; gap:6px; }
    .chip{
      border:1px solid var(--line); background: var(--card); color: var(--text);
      padding:10px 14px; border-radius:999px; font-size:13px; font-weight:900;
      cursor:pointer; transition:0.2s; flex-grow: 1; text-align: center; user-select:none;
    }
    .chip.active{ border-color: var(--brand); background: rgba(255,63,52,0.15); color: #ff6b6b; }
    .chip.okActive{ border-color: var(--ok); box-shadow: 0 0 0 2px rgba(16,185,129,0.12) inset; color: var(--ok); }
    .chip.warnActive{ border-color: var(--warn); box-shadow: 0 0 0 2px rgba(245,158,11,0.12) inset; color: var(--warn); }

    .row{ display:flex; gap:10px; flex-wrap:wrap; margin-bottom: 12px;}
    .kv{
      flex:1; display:flex; justify-content:space-between; align-items:center;
      font-size:13px; border:1px solid var(--line); background: var(--bg);
      padding:10px 14px; border-radius:12px; gap:10px;
    }
    .kv select{
      background: var(--card); border:1px solid var(--line); color:var(--text);
      border-radius:8px; padding:8px; outline:none; font-weight:800;
    }

    .tabs{
      display:flex; gap:8px; border:1px solid var(--line); background: var(--bg);
      padding:8px; border-radius:14px; align-items:center; justify-content:space-between;
      flex-wrap:wrap; margin-top:16px;
    }
    .tabs .left{ display:flex; gap:8px; flex-wrap:wrap; }
    .tab{
      border:1px solid var(--line); background: var(--card); color: var(--text);
      padding:8px 14px; border-radius:999px; font-size:12px; font-weight:900;
      cursor:pointer; transition:0.15s; user-select:none;
    }
    .tab.active{
      border-color: var(--ok);
      box-shadow: 0 0 0 2px rgba(16,185,129,0.15) inset;
      color: var(--ok);
    }
    .tabHint{
      color:var(--muted); font-size:12px; font-weight:900;
      padding:6px 10px; border-radius:999px;
      background: rgba(15,23,42,0.4); white-space:nowrap;
    }

    .summaryCard{ display:grid; grid-template-columns:1fr; gap:10px; margin-top:12px;}
    .pill{
      border:1px solid var(--line); background: var(--bg);
      border-radius:12px; padding:14px;
      display:flex; justify-content:space-between; gap:10px; align-items:flex-start;
    }
    .pill .k{ color:var(--muted); font-size:12px; margin-bottom: 4px; font-weight:900;}
    .pill .v{ font-weight:900; font-size: 14px; line-height: 1.4;}
    .pill .v.ok{ color:var(--ok); } .pill .v.warn{ color:var(--warn); } .pill .v.cyan{ color:var(--cyan); }

    .report{
      margin-top:12px; background: var(--black); color: var(--ok);
      border:1px solid rgba(16,185,129,0.3); border-radius:12px;
      padding:16px; white-space:pre-wrap; font-family: ui-monospace, Menlo, Monaco, Consolas, "Courier New", monospace;
      font-size:13px; overflow-x:auto; line-height:1.6;
    }

    .spinner{
      width:18px; height:18px; border-radius:50%;
      border:2px solid rgba(255,255,255,0.3);
      border-top-color: #fff; animation: spin 0.8s linear infinite; display:none;
    }
    @keyframes spin{ to{ transform: rotate(360deg);} }
    canvas{ display:none; }

    .dim{ opacity:0.55; }
    .tag{
      display:inline-flex; align-items:center; gap:6px; font-size:11px; font-weight:900;
      padding:6px 10px; border-radius:999px; border:1px solid var(--line); background: rgba(15,23,42,0.35);
      color: var(--muted);
    }
    .tag.ok{ color: var(--ok); border-color: rgba(16,185,129,0.35); }
    .tag.warn{ color: var(--warn); border-color: rgba(245,158,11,0.35); }
  </style>
</head>

<body>
  <div class="app">
    <div class="header">
      <div class="title">
        <h1>ğŸ“· Recipe & 3D LUT ìƒì„±ê¸° <span style="color:var(--cyan); font-size:14px;">v8.2 Quick/Pro</span></h1>
        <p>
          <b>Quick(1ì¥)</b>: íƒ€ê²Ÿë§Œ ë„£ê³  ë¹ ë¥´ê²Œ ë ˆì‹œí”¼/LUT ìƒì„± Â· <b>Pro(2ì¥)</b>: ì˜¤ë¦¬ì§€ë„+íƒ€ê²Ÿ ì°¨ì´ë¡œ ì •ë°€ ìƒì„±
        </p>
      </div>
      <div class="badges">
        <div class="badge"><span id="dotAI" class="dot warn"></span><span id="aiText">AI ë¡œë”©ì¤‘</span></div>
        <div class="badge"><span id="dotOrig" class="dot"></span> ì˜¤ë¦¬ì§€ë„</div>
        <div class="badge"><span id="dotRef" class="dot"></span> íƒ€ê²Ÿ</div>
        <div class="badge"><span id="dotReady" class="dot warn"></span><span id="readyText">ì¤€ë¹„ ëŒ€ê¸°</span></div>
      </div>
    </div>

    <div class="grid">
      <!-- STEP 1 -->
      <div class="card">
        <div class="card-h">
          <strong>STEP 1. ì‚¬ì§„ ì„ íƒ</strong>
          <span class="step">1/3</span>
        </div>
        <div class="card-b">
          <div class="uploader">

            <div class="drop" id="dropOrig">
              <div class="label">
                1) ì˜¤ë¦¬ì§€ë„(ì„ íƒ)
                <span class="tag" id="origTag">Pro ëª¨ë“œì—ì„œ ê¶Œì¥</span>
              </div>
              <div class="hint" id="origHint">
                <b>Pro(2ì¥) ì •ë°€ ëª¨ë“œìš©</b> ê¸°ì¤€ ì‚¬ì§„ì…ë‹ˆë‹¤.<br/>
                ê°™ì€ ì¥ì†Œ/í”¼ì‚¬ì²´ë¥¼ <b>ê¸°ë³¸ í†¤(í‘œì¤€/ë‰´íŠ¸ëŸ´)</b>ë¡œ ì°ì€ ì‚¬ì§„ì´ ê°€ì¥ ì¢‹ìŠµë‹ˆë‹¤.
              </div>
              <input id="origFile" type="file" accept="image/*"/>
              <img id="thumbOrig" class="thumb" alt="orig"/>
              <div id="fileOrig" class="filename"></div>
            </div>

            <div class="drop" id="dropRef">
              <div class="label">
                2) íƒ€ê²Ÿ(í•„ìˆ˜)
                <span class="tag ok">í•­ìƒ í•„ìš”</span>
              </div>
              <div class="hint" id="refHint">
                <b>ì›í•˜ëŠ” ìƒ‰ê°</b>(ì˜í™”/í•„ë¦„/ì¸ìŠ¤íƒ€ ë£©) ì°¸ê³  ì‚¬ì§„ì„ ë„£ìœ¼ì„¸ìš”.<br/>
                ì´ˆë³´ìëŠ” <b>ì¤‘ê°„í†¤ì´ ë§ê³  ë„ˆë¬´ ì–´ë‘¡ì§€ ì•Šì€ ì‚¬ì§„</b>ì´ ê²°ê³¼ê°€ ì•ˆì •ì ì…ë‹ˆë‹¤.
              </div>
              <input id="refFile" type="file" accept="image/*"/>
              <img id="thumbRef" class="thumb" alt="ref"/>
              <div id="fileRef" class="filename"></div>
            </div>

            <div class="mini">
              <b>ğŸ“Œ ì´ˆë³´ììš© ì‚¬ì§„ ì„ íƒ ê°€ì´ë“œ</b><br/>
              â€¢ <b>Quick(1ì¥)</b>: íƒ€ê²Ÿë§Œ ë„£ì–´ë„ ë©ë‹ˆë‹¤. (ë‚´ë¶€ â€œì¤‘ë¦½ ê¸°ì¤€â€ìœ¼ë¡œ ê³„ì‚°)<br/>
              â€¢ <b>Pro(2ì¥)</b>: ì˜¤ë¦¬ì§€ë„ì€ â€œí˜„ì¬ ë‚´ ì¹´ë©”ë¼ ê¸°ë³¸í†¤â€ ê¸°ì¤€ì ì…ë‹ˆë‹¤.<br/><br/>
              <b>ì˜¤ë¦¬ì§€ë„ ì¶”ì²œ ì˜ˆì‹œ</b><br/>
              - ê°™ì€ ì¥ì†Œ/í”¼ì‚¬ì²´ë¥¼ <b>í‘œì¤€(Standard) / ë‰´íŠ¸ëŸ´(Neutral)</b>ë¡œ ì´¬ì˜<br/>
              - ë…¸ì¶œ ê³¼í•˜ê²Œ í”ë“¤ë¦° ì‚¬ì§„, ì‹¬í•œ ì—­ê´‘, ê³¼í•œ ìƒ‰ì¡°ëª…(í´ëŸ½/ë„¤ì˜¨)ì€ í”¼í•˜ê¸°<br/><br/>
              <b>íƒ€ê²Ÿ ì¶”ì²œ ì˜ˆì‹œ</b><br/>
              - â€œì›í•˜ëŠ” ë£©ì´ ì˜ ë‚˜ì˜¨ ì‚¬ì§„â€ (ì˜í™” ìŠ¤í‹¸, ë ˆí¼ëŸ°ìŠ¤ ìƒ·, ë³¸ì¸ ì‚¬ì§„ ë“±)
            </div>

          </div>
        </div>
      </div>

      <!-- STEP 2 -->
      <div class="card">
        <div class="card-h">
          <strong>STEP 2. ëª¨ë“œ/ë¶„ì„</strong>
          <span class="step">2/3</span>
        </div>
        <div class="card-b">
          <!-- Quick / Pro -->
          <div class="seg">
            <div class="label">ì‘ì—… ë°©ì‹ ì„ íƒ (í„°ì¹˜)</div>
            <div class="chips">
              <div class="chip okActive" data-qpmode="quick" onclick="setQPMode('quick')">Quick (1ì¥)</div>
              <div class="chip" data-qpmode="pro" onclick="setQPMode('pro')">Pro (2ì¥)</div>
            </div>
            <div class="mini" id="qpExplain" style="margin-top:6px;">
              <b>Quick</b>: íƒ€ê²Ÿë§Œìœ¼ë¡œ ë¹ ë¥´ê²Œ ìƒì„± (ëŒ€ëµ ë ˆì‹œí”¼, ì´ˆë³´ ì¹œí™”).<br/>
              <b>Pro</b>: ì˜¤ë¦¬ì§€ë„â†”íƒ€ê²Ÿ ì°¨ì´ë¡œ ì •ë°€ ìƒì„± (ì¶”ì²œ).
            </div>
          </div>

          <!-- Content mode -->
          <div class="seg">
            <div class="label">í”¼ì‚¬ì²´ ëª¨ë“œ (í„°ì¹˜)</div>
            <div class="chips">
              <div class="chip active" data-mode="auto" onclick="setMode('auto')">AI ìë™</div>
              <div class="chip" data-mode="portrait" onclick="setMode('portrait')">ì¸ë¬¼</div>
              <div class="chip" data-mode="landscape" onclick="setMode('landscape')">í’ê²½</div>
              <div class="chip" data-mode="snap" onclick="setMode('snap')">ìŠ¤ëƒ…</div>
              <div class="chip" data-mode="night" onclick="setMode('night')">ì•¼ê²½</div>
            </div>
          </div>

          <div class="row">
            <div class="kv">
              <b>í•´ìƒë„</b>
              <select id="maxDim">
                <option value="1024" selected>1024px</option>
                <option value="1280">1280px</option>
              </select>
            </div>
          </div>

          <button id="btnAnalyze" class="btn primary" onclick="analyzeAll()" disabled>
            âš¡ ë¶„ì„ ì‹œì‘ <span id="spin" class="spinner"></span>
          </button>

          <div class="mini" style="margin-top:12px;">
            <b>âœ… ì•ˆì •ì„±</b><br/>
            - ëŒ€ìš©ëŸ‰ ì´ë¯¸ì§€ë„ ìµœëŒ€ í•´ìƒë„ë¡œ ì¶•ì†Œ ë¶„ì„ (í”„ë¦¬ì§• ë°©ì§€)<br/>
            - ìƒ‰ìƒ/í†¤ ì—°ì‚°ì€ Web Workerì—ì„œ ìˆ˜í–‰ (UI ë©ˆì¶¤ ìµœì†Œí™”)<br/>
            - AI ë¡œë”© ì‹¤íŒ¨ ì‹œì—ë„ ìë™ ìš°íšŒ ë™ì‘
          </div>
        </div>
      </div>

      <!-- STEP 3 -->
      <div class="card" style="grid-column: 1 / -1; display:none;" id="resultCard">
        <div class="card-h">
          <strong>STEP 3. ê²°ê³¼</strong>
          <span class="step" style="color:var(--ok); border-color:var(--ok);">ì™„ë£Œ</span>
        </div>
        <div class="card-b">
          <div style="display:flex; flex-direction:column; gap:10px;">
            <button id="btnLut" class="btn lut" onclick="downloadLUT()">ğŸ¬ 3D LUT (.cube) ë‹¤ìš´ë¡œë“œ</button>
            <div style="display:flex; gap:10px;">
              <button id="btnCopySummary" class="btn ghost" onclick="copySummary()" style="flex:1;">ğŸ“‹ ìš”ì•½ ë³µì‚¬</button>
              <button id="btnCopyFull" class="btn ghost" onclick="copyFull()" style="flex:1;">ğŸ“‹ ì „ì²´ ë³µì‚¬</button>
            </div>
          </div>

          <div class="tabs" id="tabs">
            <div class="left">
              <div class="tab active" data-tab="sum" onclick="setTab('sum')">ìš”ì•½ ë³´ê¸°</div>
              <div class="tab" data-tab="full" onclick="setTab('full')">ì „ì²´ ë³´ê¸°</div>
            </div>
            <div class="tabHint" id="tabHint">ì´ˆë³´ììš© ìš”ì•½ ë·°ì…ë‹ˆë‹¤.</div>
          </div>

          <div class="summaryCard" id="summaryBox">
            <div class="pill">
              <div>
                <div class="k">ë¶„ì„ ëª¨ë“œ</div>
                <div class="v cyan" id="sumMode">-</div>
              </div>
              <div style="text-align:right;">
                <div class="k">ì¶”ì²œ ë² ì´ìŠ¤</div>
                <div class="v ok" id="sumBase">-</div>
              </div>
            </div>
            <div class="pill">
              <div>
                <div class="k">ëŒ€ë¹„(Contrast)</div>
                <div class="v" id="sumContrast">-</div>
              </div>
              <div style="text-align:right;">
                <div class="k">ë¸”ë™ ë¦¬í”„íŠ¸</div>
                <div class="v" id="sumLift">-</div>
              </div>
            </div>
            <div class="pill">
              <div>
                <div class="k">í†¤ ì»¤ë¸Œ(Luminance)</div>
                <div class="v" id="sumCurve" style="white-space:pre-wrap; font-size:13px;">-</div>
              </div>
            </div>
            <div class="pill">
              <div>
                <div class="k">6ìƒ‰ì¶•(H/S/L)</div>
                <div class="v" id="sumColors" style="white-space:pre-wrap; font-size:13px;">-</div>
              </div>
            </div>

            <div class="mini">
              <b>ğŸ“· PSE ì…ë ¥ ìˆœì„œ (ìš”ì•½)</b><br/>
              1) Base = <b id="sumBase2">-</b><br/>
              2) Contrast = <b id="sumContrast2">-</b><br/>
              3) Tone Curve = ìœ„ 5ê°œ í¬ì¸íŠ¸ ì…ë ¥<br/>
              4) Specific Colors = 6ìƒ‰ì¶• ìˆ˜ì¹˜ ì…ë ¥<br/><br/>
              <b>íŒ</b>: Quick(1ì¥)ì€ â€œëŒ€ëµê°’â€ì´ë¼, ê²°ê³¼ê°€ ê³¼í•˜ë©´ ìƒ‰ì¶•(H/S/L)ë¶€í„° í•œ ë‹¨ê³„ì”© ì¤„ì´ëŠ” ê²Œ ì •ì„ì…ë‹ˆë‹¤.
            </div>
          </div>

          <div id="fullBox" style="display:none; margin-top:12px;">
            <div id="reportBox" class="report"></div>
          </div>

          <canvas id="canvas"></canvas>
        </div>
      </div>

    </div>
  </div>

<script>
/* =========================
   ìƒíƒœ
========================= */
let origFileState = null;
let refFileState = null;

let summaryText = "";
let fullText = "";

let globalToneLUT = null;
let globalColorSliders = null;

let worker = null;
let faceModel = null;
let classifyModel = null;
let isAiReady = false;

let userMode = "auto";    // auto/portrait/landscape/snap/night
let qpMode   = "quick";   // quick/pro
let viewTab  = "sum";

/* =========================
   UI Helpers
========================= */
function setTab(tab){
  viewTab = tab;
  document.querySelectorAll(".tab").forEach(el=>{
    el.classList.toggle("active", el.dataset.tab === tab);
  });
  const hint = document.getElementById("tabHint");
  if(tab === "sum"){
    hint.textContent = "ì´ˆë³´ììš© ìš”ì•½ ë·°ì…ë‹ˆë‹¤.";
    document.getElementById("summaryBox").style.display = "grid";
    document.getElementById("fullBox").style.display = "none";
  }else{
    hint.textContent = "ìƒì„¸ ë ˆì‹œí”¼ ë¦¬í¬íŠ¸ì…ë‹ˆë‹¤.";
    document.getElementById("summaryBox").style.display = "none";
    document.getElementById("fullBox").style.display = "block";
  }
}

function setMode(mode){
  userMode = mode;
  document.querySelectorAll(".chip").forEach(el=>{
    if(el.dataset.mode){
      el.classList.toggle("active", el.dataset.mode === mode);
    }
  });
}

function setQPMode(mode){
  qpMode = mode;

  // chips
  document.querySelectorAll(".chip").forEach(el=>{
    if(el.dataset.qpmode){
      el.classList.toggle("active", el.dataset.qpmode === mode);
      el.classList.toggle("okActive", el.dataset.qpmode === "quick" && el.dataset.qpmode === mode);
      el.classList.toggle("warnActive", el.dataset.qpmode === "pro" && el.dataset.qpmode === mode);
    }
  });

  // explain + orig UI emphasis
  const origDrop = document.getElementById("dropOrig");
  const origTag  = document.getElementById("origTag");
  const origHint = document.getElementById("origHint");
  const qpExplain = document.getElementById("qpExplain");

  if(mode === "quick"){
    qpExplain.innerHTML =
      "<b>Quick</b>: íƒ€ê²Ÿ 1ì¥ë§Œìœ¼ë¡œ ë¹ ë¥´ê²Œ ìƒì„± (ë‚´ë¶€ ì¤‘ë¦½ ê¸°ì¤€).<br/>" +
      "<b>Pro</b>: ì˜¤ë¦¬ì§€ë„+íƒ€ê²Ÿ ì°¨ì´ë¡œ ì •ë°€ ìƒì„± (ì¶”ì²œ).";
    origDrop.classList.add("dim");
    origTag.className = "tag";
    origTag.textContent = "Quickì—ì„  ì„ íƒ";
    origHint.innerHTML =
      "<b>Quick(1ì¥)</b>ì—ì„œëŠ” ì—†ì–´ë„ ë©ë‹ˆë‹¤.<br/>" +
      "ì˜¤ë¦¬ì§€ë„ì„ ë„£ìœ¼ë©´(ìˆë‹¤ë©´) Proë¡œ ë°”ê¾¸ëŠ” ê±¸ ì¶”ì²œí•©ë‹ˆë‹¤.";
  } else {
    qpExplain.innerHTML =
      "<b>Pro</b>: ì˜¤ë¦¬ì§€ë„â†”íƒ€ê²Ÿ ì°¨ì´ë¡œ ì •ë°€ ìƒì„± (ê°€ì¥ ì¶”ì²œ).<br/>" +
      "<b>Quick</b>: íƒ€ê²Ÿë§Œìœ¼ë¡œ ë¹ ë¥¸ ìƒì„± (ëŒ€ëµê°’).";
    origDrop.classList.remove("dim");
    origTag.className = "tag warn";
    origTag.textContent = "Proì—ì„œ í•„ìˆ˜ê¸‰";
    origHint.innerHTML =
      "<b>Pro(2ì¥)</b>ì˜ ê¸°ì¤€ ì‚¬ì§„ì…ë‹ˆë‹¤.<br/>" +
      "ê°™ì€ ì¥ì†Œ/í”¼ì‚¬ì²´ë¥¼ <b>í‘œì¤€(Standard)/ë‰´íŠ¸ëŸ´(Neutral)</b>ë¡œ ì°ì€ ì‚¬ì§„ì´ ê°€ì¥ ì¢‹ìŠµë‹ˆë‹¤.";
  }

  refreshReady();
}

function setDot(id, state){
  const el = document.getElementById(id);
  el.className = "dot " + (state || "");
}

/* =========================
   AI ë¡œë”©
========================= */
async function loadAIModels() {
  const dot = document.getElementById('dotAI');
  const text = document.getElementById('aiText');
  try {
    await tf.ready();
    faceModel = await blazeface.load();
    classifyModel = await mobilenet.load();
    isAiReady = true;
    dot.className = "dot ok";
    text.textContent = "AI ì¤€ë¹„ì™„ë£Œ";
  } catch(e) {
    console.warn("AI ë¡œë”© ì‹¤íŒ¨:", e);
    // ì‹¤íŒ¨í•´ë„ ìš°íšŒ
    isAiReady = true;
    dot.className = "dot warn";
    text.textContent = "AI ì‹¤íŒ¨(ìš°íšŒ)";
  } finally {
    refreshReady();
  }
}

/* =========================
   ì—…ë¡œë“œ
========================= */
function setupDropZone(dropId, inputId, thumbId, nameId, onSetFile) {
  const drop = document.getElementById(dropId);
  const input = document.getElementById(inputId);
  const thumb = document.getElementById(thumbId);
  const nameEl = document.getElementById(nameId);

  drop.onclick = ()=> input.click();
  drop.ondragover = (e)=>{ e.preventDefault(); drop.classList.add('dragover'); };
  drop.ondragleave = ()=> drop.classList.remove('dragover');
  drop.ondrop = (e)=>{
    e.preventDefault(); drop.classList.remove('dragover');
    const f = e.dataTransfer.files && e.dataTransfer.files[0];
    if(f){
      onSetFile(f);
      updatePreview(f, thumb, nameEl);
      refreshReady();
    }
  };
  input.onchange = ()=>{
    const f = input.files && input.files[0];
    if(f){
      onSetFile(f);
      updatePreview(f, thumb, nameEl);
      refreshReady();
    }
  };
}

function updatePreview(file, imgEl, nameEl){
  nameEl.textContent = "âœ… " + file.name;
  nameEl.style.display = "block";
  const r = new FileReader();
  r.onload = e=>{
    imgEl.src = e.target.result;
    imgEl.style.display = "block";
  };
  r.readAsDataURL(file);
}

/* =========================
   ì¤€ë¹„ ìƒíƒœ
========================= */
function refreshReady(){
  const hasOrig = !!origFileState;
  const hasRef  = !!refFileState;

  setDot('dotOrig', hasOrig ? 'ok' : '');
  setDot('dotRef',  hasRef  ? 'ok' : '');

  // Quick: íƒ€ê²Ÿë§Œ í•„ìš”
  // Pro: ì˜¤ë¦¬ì§€ë„ + íƒ€ê²Ÿ í•„ìš”
  const ready = isAiReady && hasRef && (qpMode === "quick" ? true : hasOrig);

  setDot('dotReady', ready ? 'ok' : 'warn');
  document.getElementById('readyText').textContent = ready ? "ë¶„ì„ ê°€ëŠ¥" : (qpMode==="quick" ? "íƒ€ê²Ÿ í•„ìš”" : "ì˜¤ë¦¬ì§€ë„+íƒ€ê²Ÿ í•„ìš”");
  document.getElementById('btnAnalyze').disabled = !ready;

  // Quickì¼ ë•Œ ì˜¤ë¦¬ì§€ë„ ë“œëì˜ dimì€ setQPModeì—ì„œ ì²˜ë¦¬
}

/* =========================
   Worker ì´ˆê¸°í™” (Quick/Pro ì§€ì›)
========================= */
function initWorker(){
  if(worker) return;

  const workerCode = `
  function clamp(v, a, b){ return v<a?a:(v>b?b:v); }

  function rgbToHsl(r,g,b){
    r/=255; g/=255; b/=255;
    const max=Math.max(r,g,b), min=Math.min(r,g,b);
    let h=0,s=0; const l=(max+min)/2;
    if(max!==min){
      const d=max-min;
      s = l>0.5 ? d/(2-max-min) : d/(max+min);
      switch(max){
        case r: h=(g-b)/d+(g<b?6:0); break;
        case g: h=(b-r)/d+2; break;
        case b: h=(r-g)/d+4; break;
      }
      h/=6;
    }
    return [h*360,s,l];
  }

  function circularHueDiff(h2,h1){
    let d=(h2-h1)%360;
    if(d>180) d-=360;
    if(d<=-180) d+=360;
    return d;
  }

  function luminanceHistFromRGBA(rgba){
    const hist = new Uint32Array(256);
    let total=0, tooDark=0, tooBright=0;
    for(let i=0;i<rgba.length;i+=4){
      const lum = (0.299*rgba[i] + 0.587*rgba[i+1] + 0.114*rgba[i+2]) | 0;
      hist[lum]++; total++;
      if(lum<=5) tooDark++;
      if(lum>=250) tooBright++;
    }
    return {hist, total, tooDark, tooBright};
  }

  function cdfFromHist(hist, total){
    const cdf = new Float32Array(256);
    let acc=0;
    for(let i=0;i<256;i++){ acc+=hist[i]; cdf[i]=acc/total; }
    return cdf;
  }

  function percentileByHist(hist, total, p){
    const target = total * p;
    let acc=0;
    for(let i=0;i<256;i++){
      acc += hist[i];
      if(acc >= target) return i;
    }
    return 255;
  }

  // Quick(1ì¥)ìš©: ì„ í˜•(ì¤‘ë¦½) CDF ìƒì„±
  function linearCDF(){
    const cdf = new Float32Array(256);
    for(let i=0;i<256;i++) cdf[i] = (i+1)/256;
    return cdf;
  }

  function buildToneLUTByCDFMatch(cdfO, cdfR){
    const lut = new Uint8Array(256);
    let j=0;
    for(let i=0;i<256;i++){
      const p = cdfO[i];
      while(j<255 && cdfR[j] < p) j++;
      lut[i]=j;
    }
    return lut;
  }

  function applyBlackLiftCompensation(lut, refP02){
    const liftRaw = Math.max(0, refP02 - 8);
    const strength = Math.max(0, Math.min(1, liftRaw/22));
    const liftPx = Math.round(6 + 18*strength);

    const out = new Uint8Array(256);
    for(let i=0;i<256;i++){
      let boost = 0;
      if(i < 128) boost = liftPx * (1 - (i/128)); // ì•”ë¶€ìª½ ë” ê°•í•˜ê²Œ
      out[i] = Math.min(255, lut[i] + boost);
      if(i>0 && out[i] < out[i-1]) out[i] = out[i-1];
    }
    return {lut: out, isLifted: strength>=0.20, strength, liftPx};
  }

  function getColorAxesDataWeighted(rgba){
    const buckets = {
      R:{sumCos:0,sumSin:0,sumS:0,sumL:0,wSum:0,count:0},
      Y:{sumCos:0,sumSin:0,sumS:0,sumL:0,wSum:0,count:0},
      G:{sumCos:0,sumSin:0,sumS:0,sumL:0,wSum:0,count:0},
      C:{sumCos:0,sumSin:0,sumS:0,sumL:0,wSum:0,count:0},
      B:{sumCos:0,sumSin:0,sumS:0,sumL:0,wSum:0,count:0},
      M:{sumCos:0,sumSin:0,sumS:0,sumL:0,wSum:0,count:0},
    };

    let valid=0;
    for(let i=0;i<rgba.length;i+=4){
      let [h,s,l] = rgbToHsl(rgba[i],rgba[i+1],rgba[i+2]);

      if(s<0.08 || l<0.06 || l>0.94) continue;

      let k='M';
      if(h>=340 || h<20) k='R';
      else if(h>=20 && h<80) k='Y';
      else if(h>=80 && h<150) k='G';
      else if(h>=150 && h<210) k='C';
      else if(h>=210 && h<280) k='B';

      const w = Math.max(0.01, Math.pow(s,1.5) * (1.0 - Math.min(0.8, Math.abs(l-0.5)*1.6)));
      const rad=h*Math.PI/180;
      const bk=buckets[k];

      bk.sumCos+=Math.cos(rad)*w;
      bk.sumSin+=Math.sin(rad)*w;
      bk.sumS+=s*w;
      bk.sumL+=l*w;
      bk.wSum+=w;
      bk.count++;
      valid++;
    }

    const out={};
    for(const k in buckets){
      const b=buckets[k];
      if(b.wSum>0){
        let h=Math.atan2(b.sumSin, b.sumCos)*180/Math.PI;
        if(h<0) h+=360;
        out[k]={H:h, S:b.sumS/b.wSum, L:b.sumL/b.wSum, count:b.count};
      }else{
        out[k]={H:0,S:0,L:0,count:0};
      }
    }
    return {axes: out, validColored: valid};
  }

  // Quick(1ì¥)ìš©: â€œê°€ìƒ ì˜¤ë¦¬ì§€ë„(ì¤‘ë¦½ ê¸°ì¤€)â€ ì¶• ë°ì´í„° ìƒì„±
  function makeNeutralAxesLike(refAxes){
    const centers = { R:0, Y:50, G:115, C:180, B:245, M:300 };
    const out = {};
    for(const k in centers){
      const ref = refAxes[k] || {count:0};
      const cnt = Math.max(2000, ref.count || 0); // ì‹ ë¢°ë„/ê°ì‡  ê³¼ë„ ë°©ì§€ìš©
      out[k] = { H: centers[k], S:0.35, L:0.50, count: cnt };
    }
    return out;
  }

  function recommendBase(contrast, refAxes, totalColored, aiType, userMode, qpMode){
    // userMode(ìˆ˜ë™)ê°€ ìˆìœ¼ë©´ ìµœìš°ì„  ë°˜ì˜
    if(userMode && userMode !== "auto"){
      if(userMode === "portrait")   return {recBase:"ì¸ë¬¼ì‚¬ì§„ (Portrait)",   recReason:"[ìˆ˜ë™] ì¸ë¬¼ ëª¨ë“œ ì„ íƒ"};
      if(userMode === "landscape")  return {recBase:"í’ê²½ì‚¬ì§„ (Landscape)", recReason:"[ìˆ˜ë™] í’ê²½ ëª¨ë“œ ì„ íƒ"};
      if(userMode === "snap")       return {recBase:"í‘œì¤€ (Standard)",      recReason:"[ìˆ˜ë™] ìŠ¤ëƒ… ëª¨ë“œ: ë²”ìš© ë² ì´ìŠ¤"};
      if(userMode === "night")      return {recBase:"ë‰´íŠ¸ëŸ´ (Neutral)",     recReason:"[ìˆ˜ë™] ì•¼ê²½ ëª¨ë“œ: ê³„ì¡° í™•ë³´ ìš°ì„ "};
    }

    // AI ìš°ì„  (autoì¼ ë•Œë§Œ ì˜ë¯¸)
    if(aiType === "portrait")  return {recBase:"ì¸ë¬¼ì‚¬ì§„ (Portrait)", recReason:"[AI] ì–¼êµ´ ê°ì§€ ê¸°ë°˜ ì¶”ì²œ"};
    if(aiType === "landscape") return {recBase:"í’ê²½ì‚¬ì§„ (Landscape)", recReason:"[AI] í’ê²½/ìì—° ê°ì§€ ê¸°ë°˜ ì¶”ì²œ"};

    // ìƒ‰ìƒ ë¹„ì¤‘ ê¸°ë°˜
    if(totalColored < 1500){
      return {recBase:"ëª¨ë…¸í¬ë¡¬ (Monochrome)", recReason:"ìœ íš¨ ìƒ‰ìƒ ë°ì´í„°ê°€ ì ì–´ ë¬´ì±„ìƒ‰ ì„±í–¥"};
    }

    const ry = (refAxes.R.count + refAxes.Y.count);
    const gbc = (refAxes.G.count + refAxes.B.count + refAxes.C.count);

    if(ry > totalColored*0.55) return {recBase:"ì¸ë¬¼ì‚¬ì§„ (Portrait)", recReason:"R/Y ë¹„ì¤‘(í”¼ë¶€í†¤ ê³„ì—´) ë†’ìŒ"};
    if(gbc > totalColored*0.45) return {recBase:"í’ê²½ì‚¬ì§„ (Landscape)", recReason:"G/B/C ë¹„ì¤‘(ìì—°/í•˜ëŠ˜) ë†’ìŒ"};

    // ëŒ€ë¹„ ë‚®ìœ¼ë©´ Neutral ìœ ë„
    if(contrast <= -2) return {recBase:"ë‰´íŠ¸ëŸ´ (Neutral)", recReason:"ëŒ€ë¹„ ë‚®ìŒ: ê³„ì¡° í™•ë³´ì— ìœ ë¦¬"};

    // Quickì¼ ë•ŒëŠ” ì•ˆì „í•˜ê²Œ Standard
    if(qpMode === "quick") return {recBase:"í‘œì¤€ (Standard)", recReason:"Quick(1ì¥): ë²”ìš© ì•ˆì •ê°’ ìš°ì„ "};

    return {recBase:"í‘œì¤€ (Standard)", recReason:"ë²”ìš©ì ì¸ ë² ì´ìŠ¤"};
  }

  self.onmessage = (e)=>{
    const {origRGBA, refRGBA, aiType, userMode, qpMode} = e.data;

    // refëŠ” í•„ìˆ˜
    const r = luminanceHistFromRGBA(refRGBA);
    const cR = getColorAxesDataWeighted(refRGBA);

    // ===== Tone: Quick vs Pro =====
    let cdfO, oRange;

    if(qpMode === "quick" || !origRGBA){
      // Quick: ì„ í˜•(ì¤‘ë¦½) ê¸°ì¤€
      cdfO = linearCDF();
      // ì„ í˜• ë¶„í¬ì—ì„œ p05â‰ˆ13, p95â‰ˆ242 => rangeâ‰ˆ229
      oRange = 229;
    } else {
      const o = luminanceHistFromRGBA(origRGBA);
      cdfO = cdfFromHist(o.hist, o.total);
      const oP05 = percentileByHist(o.hist, o.total, 0.05);
      const oP95 = percentileByHist(o.hist, o.total, 0.95);
      oRange = Math.max(1, oP95 - oP05);
    }

    const cdfR = cdfFromHist(r.hist, r.total);
    let rawLut = buildToneLUTByCDFMatch(cdfO, cdfR);

    const rP02 = percentileByHist(r.hist, r.total, 0.02);
    const liftRes = applyBlackLiftCompensation(rawLut, rP02);
    const toneLUT = liftRes.lut;

    const rP05 = percentileByHist(r.hist, r.total, 0.05);
    const rP95 = percentileByHist(r.hist, r.total, 0.95);
    const rRange = Math.max(1, rP95 - rP05);

    let contrast = clamp(Math.round(((rRange/oRange)-1)*6), -4, 4);

    // ===== Color axes: Quick vs Pro =====
    let axesO;

    if(qpMode === "quick" || !origRGBA){
      axesO = makeNeutralAxesLike(cR.axes);
    } else {
      const cO = getColorAxesDataWeighted(origRGBA);
      axesO = cO.axes;
    }

    const keys  = ['R','Y','G','C','B','M'];
    const names = ["Red(ë¹¨ê°•)","Yellow(ë…¸ë‘)","Green(ì´ˆë¡)","Cyan(ì‹œì•ˆ)","Blue(íŒŒë‘)","Magenta(ë§ˆì  íƒ€)"];
    const colorSliders = [];

    for(let i=0;i<6;i++){
      const k = keys[i];
      const o = axesO[k];
      const rr = cR.axes[k];

      const countO = o.count || 0;
      const countR = rr.count || 0;

      let diffH=0, diffS=0, diffL=0;

      if(countR > 50 && countO > 50){
        diffH = circularHueDiff(rr.H, o.H);
        diffS = (rr.S - o.S) * 100;
        diffL = (rr.L - o.L) * 100;
      }

      // Canon scale clamp
      const canonH = clamp(Math.round(diffH/6), -8, 8);
      const canonS = clamp(Math.round(diffS/10), -8, 8);
      const canonL = clamp(Math.round(diffL/10), -8, 8);

      colorSliders.push({
        label: names[i],
        axis: k,
        H: diffH, S: diffS, L: diffL,
        canonH, canonS, canonL,
        countRef: countR
      });
    }

    // warnings (ë‹¨ìˆœ)
    const warnings = [];
    const darkRatio = r.tooDark / Math.max(1, r.total);
    const brightRatio = r.tooBright / Math.max(1, r.total);
    if(darkRatio > 0.35) warnings.push("íƒ€ê²Ÿì´ ë§¤ìš° ì–´ë‘¡ìŠµë‹ˆë‹¤(ì•”ë¶€ ë¹„ì¤‘â†‘).");
    if(brightRatio > 0.35) warnings.push("íƒ€ê²Ÿì´ ë§¤ìš° ë°ìŠµë‹ˆë‹¤(ëª…ë¶€ ë¹„ì¤‘â†‘).");
    if(cR.validColored < 1500) warnings.push("ìœ íš¨ ìƒ‰ìƒ ë°ì´í„°ê°€ ì ìŠµë‹ˆë‹¤(ì €ì±„ë„/ë¬´ì±„ìƒ‰).");

    const base = recommendBase(contrast, cR.axes, cR.validColored, aiType, userMode, qpMode);

    self.postMessage({
      ok:true,
      contrast,
      toneLUT,
      isLifted: liftRes.isLifted,
      liftStrength: liftRes.strength,
      liftPx: liftRes.liftPx,
      rP02,
      base,
      reason: base.recReason,
      colorSliders,
      diagnostics: {
        totalColored: cR.validColored,
        darkRatio, brightRatio,
        warnings
      }
    });
  };
  `;

  const url = URL.createObjectURL(new Blob([workerCode], {type:'application/javascript'}));
  worker = new Worker(url);
  setTimeout(()=>URL.revokeObjectURL(url), 1000);
}

/* =========================
   Image decode + resize
========================= */
async function decodeToImageBitmap(file){
  // createImageBitmap(file)ëŠ” ëŒ€ë¶€ë¶„ ë¸Œë¼ìš°ì €ì—ì„œ ë¹ ë¥´ê³  ì•ˆì •ì 
  return await createImageBitmap(file);
}
function drawScaledToImageData(bitmap, maxDim){
  const scale = Math.min(1, maxDim / Math.max(bitmap.width, bitmap.height));
  const tw = Math.max(1, Math.round(bitmap.width*scale));
  const th = Math.max(1, Math.round(bitmap.height*scale));

  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d', {willReadFrequently:true});
  canvas.width = tw; canvas.height = th;

  ctx.imageSmoothingEnabled = true;
  ctx.imageSmoothingQuality = "high";
  ctx.clearRect(0,0,tw,th);
  ctx.drawImage(bitmap, 0,0,tw,th);

  return ctx.getImageData(0,0,tw,th);
}

/* =========================
   LUT (.cube) ìƒì„±
========================= */
function generateCubeLUT(toneLUT, sliders){
  const SIZE = 33;
  let content = `TITLE "Canon_Style_LUT_v8_2"\nLUT_3D_SIZE ${SIZE}\n\n`;

  const rgb2hsl = (r,g,b) => {
    let max = Math.max(r,g,b), min = Math.min(r,g,b);
    let h=0, s=0, l=(max+min)/2;
    if(max !== min){
      let d = max-min;
      s = l>0.5 ? d/(2-max-min) : d/(max+min);
      switch(max){
        case r: h=(g-b)/d+(g<b?6:0); break;
        case g: h=(b-r)/d+2; break;
        case b: h=(r-g)/d+4; break;
      }
      h*=60;
    }
    return [h,s,l];
  };

  const hsl2rgb = (h,s,l) => {
    let c = (1 - Math.abs(2*l - 1)) * s;
    let x = c * (1 - Math.abs((h/60)%2 - 1));
    let m = l - c/2;
    let r=0,g=0,b=0;
    if(h<60){r=c;g=x;b=0;}
    else if(h<120){r=x;g=c;b=0;}
    else if(h<180){r=0;g=c;b=x;}
    else if(h<240){r=0;g=x;b=c;}
    else if(h<300){r=x;g=0;b=c;}
    else{r=c;g=0;b=x;}
    return [r+m, g+m, b+m];
  };

  for(let bIdx=0; bIdx<SIZE; bIdx++){
    for(let gIdx=0; gIdx<SIZE; gIdx++){
      for(let rIdx=0; rIdx<SIZE; rIdx++){
        let r = Math.round((rIdx / (SIZE-1)) * 255);
        let g = Math.round((gIdx / (SIZE-1)) * 255);
        let b = Math.round((bIdx / (SIZE-1)) * 255);

        // tone
        r = toneLUT[r]; g = toneLUT[g]; b = toneLUT[b];

        // 6-axis
        let [hh, ss, ll] = rgb2hsl(r/255, g/255, b/255);

        let axisIdx = -1;
        if(hh>=340 || hh<20) axisIdx=0;
        else if(hh>=20 && hh<80) axisIdx=1;
        else if(hh>=80 && hh<150) axisIdx=2;
        else if(hh>=150 && hh<210) axisIdx=3;
        else if(hh>=210 && hh<280) axisIdx=4;
        else axisIdx=5;

        if(axisIdx !== -1 && ss > 0.05){
          const shift = sliders[axisIdx];
          hh = (hh + shift.H) % 360; if(hh<0) hh += 360;
          ss = Math.max(0, Math.min(1, ss + (shift.S/100)));
          ll = Math.max(0, Math.min(1, ll + (shift.L/100)*0.5));
        }

        const [nr, ng, nb] = hsl2rgb(hh, ss, ll);
        content += `${nr.toFixed(6)} ${ng.toFixed(6)} ${nb.toFixed(6)}\n`;
      }
    }
  }
  return content;
}

function downloadLUT(){
  if(!globalToneLUT || !globalColorSliders){
    alert("ë¨¼ì € ë¶„ì„ì„ ì§„í–‰í•´ì£¼ì„¸ìš”!");
    return;
  }
  const btn = document.getElementById('btnLut');
  btn.textContent = "â³ LUT ìƒì„± ì¤‘...";
  btn.disabled = true;

  setTimeout(()=>{
    try{
      const cubeData = generateCubeLUT(globalToneLUT, globalColorSliders);
      const blob = new Blob([cubeData], {type:'text/plain;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `Custom_Recipe_v8_2_${Date.now()}.cube`;
      a.click();
      setTimeout(()=>URL.revokeObjectURL(url), 1000);
    } finally {
      btn.textContent = "ğŸ¬ 3D LUT (.cube) ë‹¤ìš´ë¡œë“œ";
      btn.disabled = false;
    }
  }, 30);
}

/* =========================
   ë¶„ì„ ë©”ì¸
========================= */
async function analyzeAll(){
  const btn = document.getElementById('btnAnalyze');
  const spin = document.getElementById('spin');

  btn.disabled = true;
  spin.style.display = "inline-block";
  document.getElementById('resultCard').style.display = "none";

  try{
    const maxDim = parseInt(document.getElementById('maxDim').value, 10);

    // Quick: refë§Œ í•„ìš” / Pro: ë‘˜ ë‹¤ í•„ìš”
    if(!refFileState) throw new Error("íƒ€ê²Ÿ ì´ë¯¸ì§€ê°€ í•„ìš”í•©ë‹ˆë‹¤.");
    if(qpMode === "pro" && !origFileState) throw new Error("Pro ëª¨ë“œì—ì„œëŠ” ì˜¤ë¦¬ì§€ë„ ì´ë¯¸ì§€ê°€ í•„ìš”í•©ë‹ˆë‹¤.");

    // decode
    const bmR = await decodeToImageBitmap(refFileState);
    const idR = drawScaledToImageData(bmR, maxDim);

    let idO = null;
    if(qpMode === "pro" && origFileState){
      const bmO = await decodeToImageBitmap(origFileState);
      idO = drawScaledToImageData(bmO, maxDim);
    }

    // AI type (autoì¼ ë•Œë§Œ)
    let aiType = "fallback";
    if(userMode === "auto" && faceModel && classifyModel){
      try{
        // canvasì—ëŠ” ë§ˆì§€ë§‰ìœ¼ë¡œ ê·¸ë ¤ì§„ ê²ƒì´ idOì¼ ìˆ˜ ìˆìœ¼ë‹ˆ, idRì„ ë‹¤ì‹œ canvasì— ê·¸ë ¤ì„œ AI ë¶„ì„ ì¼ê´€ì„± í™•ë³´
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = idR.width; canvas.height = idR.height;
        // ImageDataë¥¼ ë°”ë¡œ putImageData (ë¹ ë¦„)
        ctx.putImageData(idR, 0, 0);

        const faces = await faceModel.estimateFaces(canvas, false);
        if(faces && faces.length > 0){
          aiType = "portrait";
        } else {
          const preds = await classifyModel.classify(canvas);
          const lsKw = ['mountain','valley','ocean','sea','beach','tree','forest','sky','nature','landscape','lake','park','river'];
          const p0 = preds && preds[0] ? (preds[0].className || "") : "";
          const isLandscape = preds?.some(p => lsKw.some(kw => (p.className||"").toLowerCase().includes(kw)));
          aiType = isLandscape ? "landscape" : "standard";
        }
      } catch(e){
        console.warn("AI ì¶”ë¡  ì‹¤íŒ¨:", e);
        aiType = "fallback";
      }
    } else {
      // ìˆ˜ë™ì´ë©´ aiTypeì€ ì°¸ê³ ìš©
      aiType = (userMode !== "auto") ? userMode : "fallback";
    }

    // Worker compute
    const refBuf = idR.data.buffer;
    const origBuf = idO ? idO.data.buffer : null;

    const result = await new Promise((resolve, reject)=>{
      const onMsg = (ev)=>{ cleanup(); resolve(ev.data); };
      const onErr = (err)=>{ cleanup(); reject(err); };
      const cleanup = ()=>{
        worker.removeEventListener('message', onMsg);
        worker.removeEventListener('error', onErr);
      };
      worker.addEventListener('message', onMsg);
      worker.addEventListener('error', onErr);

      if(origBuf){
        worker.postMessage({
          origRGBA: new Uint8ClampedArray(origBuf),
          refRGBA: new Uint8ClampedArray(refBuf),
          aiType, userMode, qpMode
        }, [origBuf, refBuf]);
      } else {
        worker.postMessage({
          origRGBA: null,
          refRGBA: new Uint8ClampedArray(refBuf),
          aiType, userMode, qpMode
        }, [refBuf]);
      }
    });

    if(!result?.ok) throw new Error("ë¶„ì„ ê²°ê³¼ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");

    const {contrast, toneLUT, isLifted, liftStrength, liftPx, rP02, base, reason, colorSliders, diagnostics} = result;

    globalToneLUT = toneLUT;
    globalColorSliders = colorSliders;

    // í…ìŠ¤íŠ¸ êµ¬ì„±
    const pts = [0,64,128,192,255].map(x => `${x}->${toneLUT[x]}`);
    const cTextInline = pts.join(" | ");
    const cTextFull = pts.map(p=>{
      const [x,y] = p.split("->");
      return `   â€¢ Point ${x} -> ${y}`;
    }).join("\n");

    const colTextInline = colorSliders.map(c=>
      `${c.label.split('(')[0]}: H${c.canonH>0?`+${c.canonH}`:c.canonH} S${c.canonS>0?`+${c.canonS}`:c.canonS} L${c.canonL>0?`+${c.canonL}`:c.canonL}`
    ).join("\n");

    const colTextFull = colorSliders.map(c=>
      `[ ${c.label} ]\n  ìƒ‰ì¡°(H): ${c.canonH>0?`+${c.canonH}`:c.canonH} | ì±„ë„(S): ${c.canonS>0?`+${c.canonS}`:c.canonS} | ëª…ë„(L): ${c.canonL>0?`+${c.canonL}`:c.canonL}`
    ).join("\n\n");

    const qpLabel = (qpMode==="quick") ? "Quick(1ì¥: ì¤‘ë¦½ ê¸°ì¤€)" : "Pro(2ì¥: ì°¨ì´ ê¸°ë°˜)";
    const modeLabel = (userMode==="auto") ? `AI ìë™ (${aiType})` : `ìˆ˜ë™ (${userMode})`;

    // ê²½ê³ 
    const warnLines = (diagnostics?.warnings && diagnostics.warnings.length)
      ? diagnostics.warnings.map((w,i)=>`${i+1}) ${w}`).join("\n")
      : "";

    summaryText =
`[Canon Picture Style Recipe - SUMMARY]
- Work: ${qpLabel}
- Subject: ${modeLabel}
1) Base: ${base}
2) Contrast: ${contrast}
3) ToneCurve(5pt): ${cTextInline}
4) SpecificColors(6-axis):
${colTextInline}`;

    fullText =
`==================================================
 ğŸ“· CANON PICTURE STYLE - RECIPE REPORT (v8.2)
==================================================
* Work Mode: ${qpLabel}
* Subject Mode: ${modeLabel}
* Target: ${refFileState ? refFileState.name : "-"}
* Original: ${origFileState ? origFileState.name : "(none)"}
* Notes: ${qpMode==="quick" ? "QuickëŠ” 'ëŒ€ëµê°’'ì…ë‹ˆë‹¤. ê³¼í•˜ë©´ ìˆ˜ì¹˜ë¥¼ 1~2ë‹¨ê³„ì”© ì¤„ì´ì„¸ìš”." : "ProëŠ” ì˜¤ë¦¬ì§€ë„â†”íƒ€ê²Ÿ ì°¨ì´ ê¸°ë°˜ìœ¼ë¡œ ë” ì •í™•í•©ë‹ˆë‹¤."}

${warnLines ? "[ âš ï¸ ì£¼ì˜ ]\n" + warnLines + "\n\n" : ""}--------------------------------------------------
[0. ì¶”ì²œ ë² ì´ìŠ¤]
â–¶ Base: [ ${base} ]
â–¶ ì´ìœ : ${reason}

--------------------------------------------------
[1. ê¸°ë³¸ ì„¤ì • (Basic Settings)]
â–¶ Contrast: ${contrast}
â–¶ ë¸”ë™ ë¦¬í”„íŠ¸: ${isLifted ? `ê°ì§€ë¨ (ê°•ë„ ${Math.round(liftStrength*100)}%, +${liftPx}px)` : "ì•½í•¨/ì—†ìŒ"}
â–¶ íƒ€ê²Ÿ ë¸”ë™(p02): ${Number(rP02).toFixed(1)}

--------------------------------------------------
[2. í†¤ ì»¤ë¸Œ ì¢Œí‘œ (Luminance)]
${cTextFull}

--------------------------------------------------
[3. íŠ¹ì • ìƒ‰ìƒ ì¡°ì • (Six Color-Axes)]
${colTextFull}
==================================================`;

    // UI ë°˜ì˜
    document.getElementById('sumMode').textContent = `${qpLabel} / ${modeLabel}`;
    document.getElementById('sumBase').textContent = base;
    document.getElementById('sumBase2').textContent = base;

    document.getElementById('sumContrast').textContent = String(contrast);
    document.getElementById('sumContrast2').textContent = String(contrast);

    document.getElementById('sumLift').textContent = isLifted ? "ê°ì§€ë¨ (ì˜í™”ë£©)" : "ì—†ìŒ";
    document.getElementById('sumLift').className = "v " + (isLifted ? "warn" : "ok");

    document.getElementById('sumCurve').textContent = cTextInline.replace(/ \| /g, "\n");
    document.getElementById('sumColors').textContent = colTextInline;

    document.getElementById('reportBox').textContent = fullText;

    document.getElementById('resultCard').style.display = "block";
    setTab("sum");
    document.getElementById('resultCard').scrollIntoView({ behavior:'smooth' });

  } catch(e){
    console.error(e);
    alert(
      "ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\n" +
      (e?.message ? `- ${e.message}\n` : "") +
      "- ì´ë¯¸ì§€ íŒŒì¼ì´ ì†ìƒë˜ì—ˆê±°ë‚˜\n- ë¸Œë¼ìš°ì €ê°€ Worker/ImageBitmapì„ ì œí•œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\n" +
      "ë‹¤ë¥¸ ì´ë¯¸ì§€ë¡œ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”."
    );
  } finally {
    spin.style.display = "none";
    refreshReady();
    btn.disabled = false;
  }
}

/* =========================
   ë³µì‚¬
========================= */
async function copySummary(){
  if(!summaryText) return;
  try{
    await navigator.clipboard.writeText(summaryText);
    alert("ìš”ì•½ì„ ë³µì‚¬í–ˆìŠµë‹ˆë‹¤!");
  } catch(e){
    const ta=document.createElement('textarea');
    ta.value=summaryText;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
    alert("ìš”ì•½ì„ ë³µì‚¬í–ˆìŠµë‹ˆë‹¤!");
  }
}

async function copyFull(){
  if(!fullText) return;
  try{
    await navigator.clipboard.writeText(fullText);
    alert("ì „ì²´ ë ˆì‹œí”¼ë¥¼ ë³µì‚¬í–ˆìŠµë‹ˆë‹¤!");
  } catch(e){
    const ta=document.createElement('textarea');
    ta.value=fullText;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
    alert("ì „ì²´ ë ˆì‹œí”¼ë¥¼ ë³µì‚¬í–ˆìŠµë‹ˆë‹¤!");
  }
}

/* =========================
   Init
========================= */
window.onload = ()=>{
  setupDropZone('dropOrig','origFile','thumbOrig','fileOrig', f=>origFileState=f);
  setupDropZone('dropRef','refFile','thumbRef','fileRef', f=>refFileState=f);

  initWorker();
  loadAIModels();

  setTab('sum');
  setQPMode('quick'); // ê¸°ë³¸ê°’: ì´ˆë³´ì ì¹œí™” Quick
  refreshReady();
};
</script>
</body>
</html>